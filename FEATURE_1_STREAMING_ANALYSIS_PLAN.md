# Feature #1: Real-time Streaming Analysis - Implementation Plan

> **Status:** ğŸ”œ Ready to Implement  
> **Created:** 2025-11-30  
> **Baseline:** MVP v1.0.0 (Commit: 2bc6779)

---

## ğŸ“‹ Feature Overview

**What:** Stream contract analysis results in real-time as they're generated by OpenAI, showing clauses appearing one-by-one with smooth animations instead of waiting for the complete analysis.

**Why Jaw-Dropping:**
- Users see immediate progress (no waiting for full analysis)
- Showcases React 19's streaming capabilities
- Demonstrates OpenAI's streaming API
- Creates a "wow" moment as clauses appear live
- Modern UX pattern (like ChatGPT's typing effect)

**User Experience:**
1. User submits contract text
2. "Analyzing..." indicator appears
3. First clause appears with animation (0.5-2s)
4. Each subsequent clause streams in with staggered animation
5. Risk meter updates as each clause is analyzed
6. Final summary appears with overall risk assessment

---

## â¶ Frontend Changes

### Components to Modify
- `web/app/playground/page.tsx` - Main playground, integrate streaming state
- `web/hooks/useAgent.ts` - Add streaming support to the hook

### New Components Needed
- `web/components/playground/streaming-clauses.tsx` - Animated clause list
- `web/components/playground/analysis-progress.tsx` - Progress indicator

### UI/UX Changes
1. **Progress Indicator:**
   - Animated progress bar or dots
   - Text showing "Analyzing clause X of Y..."
   - Smooth transition from loading â†’ streaming â†’ complete

2. **Clause Animations:**
   - Each clause fades/slides in when received
   - Staggered timing (200ms between clauses)
   - Risk badge animates in with pop effect

3. **Risk Meter Updates:**
   - Animated needle/bar that updates as clauses arrive
   - Color transitions (green â†’ yellow â†’ red)

### React 19 Showcases
- âœ… `useTransition` for non-blocking updates
- âœ… Optimistic UI updates
- âœ… Smooth state transitions
- âœ… Suspense boundaries

### Responsive Design
- âœ… Works on mobile (same animations, adjusted timing)
- âœ… Works on tablet
- âœ… Works on desktop

### Dark Mode
- âœ… All animations use theme tokens
- âœ… Progress indicators use semantic colors

---

## â· Backend Changes

### New Endpoints
- `POST /agent/run/stream` - New streaming endpoint (SSE)

### Existing Endpoints Modified
- None (pure additive)

### New Files
- `api/streaming.py` - SSE helper utilities

### Backend Logic
```python
# New endpoint: POST /agent/run/stream
# Uses Server-Sent Events (SSE) to stream clauses as they're analyzed

@app.post("/agent/run/stream")
async def run_agent_stream(body: RunBody, request: Request):
    async def generate():
        # 1. Validate and setup
        yield event(type="status", data={"status": "starting"})
        
        # 2. Extract text
        yield event(type="status", data={"status": "extracting"})
        
        # 3. Stream analysis from OpenAI
        async for clause in analyze_contract_stream(text):
            yield event(type="clause", data=clause)
        
        # 4. Final summary
        yield event(type="complete", data={"summary": ..., "overallRisk": ...})
    
    return StreamingResponse(generate(), media_type="text/event-stream")
```

### OpenAI Adapter Changes
- Add `analyze_contract_stream()` function that yields clauses progressively
- Use OpenAI's streaming API for structured outputs

### Performance Impact
- âœ… Lower perceived latency (user sees progress immediately)
- âœ… Same total processing time
- âš ï¸ Slightly more network overhead (streaming vs batch)

---

## â¸ External Services Changes

### Redis
- âœ… No changes needed
- Note: Streaming jobs don't need Redis caching (results streamed directly)

### PostgreSQL (Supabase)
- âœ… No schema changes
- âœ… Jobs still saved after completion (same as before)

### Railway
- âœ… Redeploy API service after changes
- âœ… No configuration changes

### Environment Variables
- âœ… No new variables needed

### Vercel
- âœ… No changes (frontend served normally)

---

## â¹ Breaking Changes Prevention

### Existing Features Check
- âœ… `/agent/run` endpoint remains unchanged (non-streaming still works)
- âœ… `/jobs/{id}` endpoint remains unchanged
- âœ… `/messages` endpoint remains unchanged
- âœ… `useAgent()` hook still works for non-streaming

### Strategy: Pure Additive
- New `/agent/run/stream` endpoint (doesn't modify existing)
- New `useAgentStream()` hook (doesn't modify existing)
- Toggle in UI to use streaming (default: on)
- Fallback to non-streaming if SSE fails

### Rollback Plan
1. Revert streaming components
2. `useAgent()` hook is unchanged, works immediately
3. Or: `git checkout v1.0.0`

### Data Structure Compatibility
- âœ… Streamed clauses use same `Clause` schema
- âœ… Final result uses same `ContractAnalysis` schema
- âœ… Jobs stored in same format

---

## ğŸ” Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| SSE connection drops | Medium | Low | Automatic fallback to polling |
| OpenAI streaming fails | Low | Medium | Catch error, fallback to batch |
| Animation performance | Low | Low | Use CSS transforms only |
| Mobile battery impact | Very Low | Low | Animations are CSS-only |

---

## ğŸ“ Implementation Steps

### Step 1: Backend - Streaming Endpoint (45 min)
1. Create `api/streaming.py` with SSE helpers
2. Add `analyze_contract_stream()` to `openai_adapter.py`
3. Create `POST /agent/run/stream` endpoint
4. Test with curl:
   ```bash
   curl -X POST https://api.../agent/run/stream \
     -H "Content-Type: application/json" \
     -d '{"projectId": "test", "input": {"text": "..."}}'
   ```
5. Commit backend changes

### Step 2: Frontend - Streaming Hook (30 min)
1. Create `useAgentStream()` hook in `web/hooks/useAgentStream.ts`
2. Handle SSE connection and events
3. Parse streaming events into state
4. Error handling and fallback
5. Test locally

### Step 3: Frontend - UI Components (45 min)
1. Create `streaming-clauses.tsx` with animations
2. Create `analysis-progress.tsx` component
3. Update `playground/page.tsx` to use streaming
4. Add toggle for streaming mode (dev only, default on)
5. Test locally on all devices

### Step 4: Integration Testing (20 min)
1. Test full flow: submit â†’ stream â†’ complete
2. Test error scenarios (network drop, API error)
3. Test on mobile/tablet
4. Test dark mode
5. Verify existing features still work

### Step 5: Deploy & Test Production (15 min)
1. Push to GitHub
2. Monitor Railway deployment
3. Test on production URLs
4. Verify streaming works end-to-end

---

## â±ï¸ Time Estimation

| Phase | Estimated |
|-------|-----------|
| Backend (streaming endpoint) | 45 min |
| Frontend (hook) | 30 min |
| Frontend (UI components) | 45 min |
| Integration testing | 20 min |
| Deployment | 15 min |
| Documentation | 15 min |
| **Total** | **~2.5 hours** |

---

## ğŸ¨ UI Mockup (Text)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Contract Analysis                                          â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 60%                          â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ âœ“ Payment Terms          [Low]          â”‚ â† Appears 1stâ”‚
â”‚  â”‚   Fees due within 30 days...            â”‚   with fade-inâ”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ âœ“ Termination            [Medium]       â”‚ â† Appears 2ndâ”‚
â”‚  â”‚   Either party may terminate...         â”‚   200ms delay â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ â— Analyzing Liability...                â”‚ â† Currently   â”‚
â”‚  â”‚   â–“â–“â–“â–“â–“â–“â–“â–“â–‘â–‘â–‘â–‘                          â”‚   streaming   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ â—‹ Confidentiality                       â”‚ â† Pending    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… Success Criteria

- [ ] Clauses appear progressively (not all at once)
- [ ] Smooth animations (no jank)
- [ ] Works in both light and dark mode
- [ ] Works on mobile, tablet, desktop
- [ ] Fallback works if streaming fails
- [ ] Existing `/agent/run` endpoint unchanged
- [ ] All existing tests pass
- [ ] No console errors
- [ ] OpenAI integration verified

---

## ğŸ“š References

- [OpenAI Streaming](https://platform.openai.com/docs/api-reference/streaming)
- [Server-Sent Events](https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events)
- [React useTransition](https://react.dev/reference/react/useTransition)
- [Framer Motion](https://www.framer.com/motion/)

---

**Ready to implement! Follow the steps in order.**

